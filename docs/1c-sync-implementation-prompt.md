# 1C Sync Map (Implementation Prompt)

Цель: поэтапно довести интеграцию 1С ↔ API ↔ БД до состояния, пригодного для маркетплейса B2B: актуальные справочники, цены, остатки, клиентские условия и заказы.

Важно: этот документ описывает «карту синхронизации» и план работ. Он не является кодом, но задаёт точный объём и последовательность реализации.

## 1. Текущая база (что уже есть)

### 1.1. Реализованные batch-импорты из 1С

См. `docs/1c-import-guide.md` и `src/modules/onec/onec.routes.ts`.

Уже реализовано:
1. `POST /api/1c/nomenclature/batch`
2. `POST /api/1c/warehouses/batch`
3. `POST /api/1c/counterparties/batch`
4. `POST /api/1c/agreements/batch`
5. `POST /api/1c/special-prices/batch`
6. `POST /api/1c/stock/batch`

### 1.2. Что уже есть в Prisma-схеме под 1С

1С-модели вынесены в отдельный файл: `prisma/schema.onec.prisma`.

Ключевые сущности:
1. Каталог: `ProductGroup`, `Product`, `Unit`, `ProductPackage`
2. Склады и остатки: `Warehouse`, `StockBalance`
3. Клиенты и условия: `Counterparty`, `DeliveryAddress`, `ClientContract`, `ClientAgreement`, `PriceType`, `SpecialPrice`
4. Заказы: `Order`, `OrderItem`, `OrderStatus`

## 2. Целевая карта синхронизации (как должно работать)

Нужно разделять 3 потока:
1. 1С → API → БД: справочники, условия, цены, остатки, статусы/факты из 1С
2. Приложение → API → БД: пользовательские действия (например, создание заказа)
3. API → 1С: выгрузка заказов и, при необходимости, других документов

## 3. Обязательные сущности для маркетплейса и их статус

Ниже — «что нужно» и «что уже покрыто».

### 3.1. Справочники и склад

1. Товары и группы: уже есть импорт
2. Склады: уже есть импорт
3. Остатки по складам: уже есть импорт
4. Единицы и упаковки: уже есть импорт

Что ещё нужно обязательно:
1. Read-API для каталога (для приложения)
2. Read-API для остатков и доступности
3. Явная стратегия «неактивности» (`isActive=false`) вместо удаления

### 3.2. Цены

Сейчас покрыто:
1. Типы цен: есть через `agreements/batch`
2. Спеццены: есть через `special-prices/batch`

Что почти наверняка потребуется добавить:
1. Базовые цены номенклатуры (общий прайс, не только спеццены)
2. Правила расчёта «эффективной цены» для клиента
3. Read-API цен под клиента/соглашение

Комментарий:
Сейчас роль «общего прайса» фактически ложится на `SpecialPrice` с пустыми привязками. Это работает, но хрупко для маркетплейса. Лучше иметь отдельную сущность базовой цены или чётко зафиксировать правило приоритетов.

### 3.3. Клиенты и условия

Сейчас покрыто:
1. Контрагенты и адреса: есть импорт
2. Договоры: есть импорт
3. Соглашения: есть импорт
4. Привязки к складу и типу цен: есть импорт

Что ещё нужно:
1. Read-API «мой профиль клиента» и «мои условия»
2. Явная модель выбора «активного» соглашения/договора/склада для клиента

### 3.4. Заказы клиентов

Сейчас:
1. Модели `Order` и `OrderItem` уже есть в Prisma
2. Импорт/экспорт заказов из/в 1С пока не реализован

Для маркетплейса обязательно:
1. Создание заказа в API
2. Экспорт заказа в 1С
3. Обратная синхронизация статусов заказа из 1С

## 4. Правила синхронизации (контракты и ключи)

Это нужно считать обязательной частью реализации.

### 4.1. Идентичность записей

Главное правило:
1. Везде, где возможно, использовать GUID из 1С как стабильный внешний ключ

Критичные места риска:
1. `ProductPackage` без GUID
2. `DeliveryAddress` без GUID
3. `SpecialPrice` без GUID и с `startDate = null`

### 4.2. Приоритеты цен (минимально необходимое правило)

Рекомендуемый порядок при расчёте цены:
1. Цена по `agreementId + productId`
2. Цена по `counterpartyId + productId`
3. Цена по `priceTypeId + productId`
4. Общая цена по товару (если будет добавлена отдельная сущность)

При равенстве уровня приоритета:
1. Берём запись с самым поздним `startDate`

### 4.3. Инкрементальные обновления

Минимально необходимый контракт:
1. Каждая запись из 1С должна нести «дату изменения в 1С»
2. API должен быть идемпотентным (повторная отправка не должна ломать данные)

## 5. Поэтапный план реализации (рекомендуемый порядок)

Ниже этапы разложены так, чтобы каждый этап давал ценность и не блокировал следующий.

### Этап 0. Стабилизация контракта интеграции

Цель: сделать интеграцию управляемой.

Нужно:
1. Зафиксировать обязательные поля и правила идемпотентности
2. Зафиксировать приоритеты цен в одном месте (док + код)
3. Договориться об удалениях: «удаляем» через `isActive=false`

### Этап 1. Справочники и склад (уже частично готово)

Цель: обеспечить целостный каталог.

Входит:
1. Номенклатура
2. Склады
3. Контрагенты и адреса
4. Договоры, соглашения, типы цен

Что нужно доделать на этом этапе:
1. Read-API для проверки данных после загрузки
2. Минимальные отчёты/диагностика по результатам batch-загрузок

### Этап 2. Цены и остатки (как товарная матрица)

Цель: получить «что можно купить и по какой цене».

Входит:
1. Спеццены
2. Остатки

Что нужно доделать:
1. Read-API «эффективная цена для клиента»
2. Read-API доступности товара по складам
3. Решение по «базовому прайсу» (отдельная сущность или формализованное правило)

### Этап 3. Заказы (критично для маркетплейса)

Цель: замкнуть контур продаж.

Нужно реализовать:
1. API создания заказа со стороны приложения
2. API выгрузки заказов в 1С
3. API приёма статусов/номеров/дат из 1С

Минимальный контракт по заказам:
1. Заказ имеет стабильный GUID в нашей системе
2. 1С возвращает `number1c`, `date1c`, `status`
3. Статусы обновляются только через интеграционный слой

### Этап 4. Обязательная обвязка для продакшн-синхронизации

Цель: сделать обмен наблюдаемым и безопасным.

Минимально нужно:
1. Журнал синхронизации (кто, когда, сколько записей, сколько ошибок)
2. Технические ключи синхронизации: `sourceUpdatedAt`, `lastSyncedAt`
3. Защита от «частичного успеха» и удобная повторная загрузка

## 6. Что ещё обычно нужно для маркетплейса (сверх базового ядра)

Это не обязательно делать сразу, но почти всегда требуется:
1. Фото товаров и медиа-галерея
2. Характеристики товаров и фильтры
3. Бренды и дополнительные категории
4. Промо-цены и акции
5. Ограничения по заказу: минимальная сумма, кратности, лимиты
6. Финансовая информация по клиенту: задолженность, кредитный лимит, блокировки
7. Логистика: доступные склады/зоны доставки/дни отгрузки

## 7. Критерий готовности (Definition of Done)

Можно считать интеграцию «готовой для маркетплейса», когда:
1. Каталог, цены и остатки можно загрузить полностью и повторно без побочных эффектов
2. Приложение может получить «эффективную цену и доступность» для конкретного клиента
3. Заказы создаются, выгружаются в 1С и возвращаются со статусами и номером 1С
4. Любая загрузка имеет отчёт: сколько принято, сколько отклонено и почему

